image: node:latest

stages:
  - compile
  - lint
  - format
  - test
  - deploy

# Setup scripts
.setup:
  front:
    - cd frontend
    - yarn set version stable
    - yarn install
  back:
    - cd backend
    - pip3 install pipenv
    - pipenv install --dev
    - pipenv shell

# Compile
compile-front:
  stage: compile
  script:
    - !reference [.setup, front]
    - yarn compile
  needs: []

compile-back:
  stage: compile
  image: python:3.8.10-buster
  script: 
    - !reference [.setup, back]
    - python3 -m compileall -q .
  needs: []

# Lint
lint-front:
  stage: lint
  script:
    - !reference [.setup, front]
    - yarn lint
  needs: [compile-front]

lint-back:
  stage: lint
  image: python:3.8.10-buster
  script:
    - !reference [.setup, back]
    - touch backend/__init__.py
    - pylint backend
  needs: [compile-back]
  

# Format
format-front:
  stage: format
  script:
    - !reference [.setup, front]
    - yarn format --check
  needs: [lint-front]

format-back:
  stage: format
  image: python:3.8.10-buster
  script:
    - !reference [.setup, back]
    - autopep8 -d --exit-code -r .
  needs: [lint-back]

# Test
test-front:
  stage: test
  script:
    - !reference [.setup, front]
    - CI=true yarn test
  needs: [format-front]

test-back:
  stage: test
  image: python:3.8.10-buster
  script:
    - !reference [.setup, back]
    - pytest
  needs: [format-back]

# Deploy
deploy-app:
  stage: deploy
  script:
    - echo "To Do"
  needs: [test-front, test-back]

